<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zyn Demo</title>
    <script src="./Z.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        background-color: #f4f4f4;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      h1,
      h2 {
        color: #333;
      }
      .editor {
        margin-top: 20px;
      }
      label {
        display: inline-block;
        margin-bottom: 5px;
      }
      select,
      input,
      button {
        margin-bottom: 10px;
        padding: 5px;
      }
      button {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        border-radius: 3px;
      }
      button:hover,
      button:focus {
        background-color: #45a049;
      }
      #instrumentJson {
        background-color: #f8f8f8;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 3px;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .github-link {
        display: inline-flex;
        align-items: center;
        text-decoration: none;
        color: #333;
        margin-top: 20px;
      }
      .github-link img {
        width: 24px;
        height: 24px;
        margin-right: 10px;
      }
      .collapsible {
        background-color: #777;
        color: white;
        cursor: pointer;
        padding: 18px;
        width: 100%;
        border: none;
        text-align: left;
        outline: none;
        font-size: 15px;
      }
      .active,
      .collapsible:hover,
      .collapsible:focus {
        background-color: #555;
      }
      .content {
        padding: 0 18px;
        display: none;
        overflow: hidden;
        background-color: #f1f1f1;
      }
      .notice {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .notice strong {
        color: #e17055;
      }
      .preset-list {
        margin-bottom: 15px;
      }
      .preset-list a {
        display: inline-block;
        margin-bottom: 10px;
        margin-right: 10px;
        padding: 5px 10px;
        background-color: #f0f0f0;
        border-radius: 3px;
        text-decoration: none;
        color: #333;
      }
      .preset-list a:hover,
      .preset-list a:focus {
        background-color: #e0e0e0;
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
      }
      .piano {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }
      .key {
        width: 40px;
        height: 120px;
        border: 1px solid #000;
        background-color: #fff;
        margin: 0 2px;
        cursor: pointer;
      }
      .key.black {
        width: 30px;
        height: 80px;
        background-color: #000;
        margin-left: -15px;
        margin-right: -15px;
        z-index: 1;
      }
      .key.pressed {
        background-color: #ddd;
      }
      .key.black.pressed {
        background-color: #444;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Zyn Demo</h1>
      </header>
      <main>
        <p>Welcome to the Zyn Demo!</p>
        <p>
          Zyn is a small JS audio synthesizer which clocks in at around 5.64kb (~2.4kb zipped). You can read all about it on GitHub
          <a href="https://github.com/AlexanderParker/zyn">here</a>.
        </p>
        <p>
          This interactive tool allows you to explore procedurally generated synthesizer instruments. Use your computer keyboard (QWERTY keys) to play notes and
          experiment with different instrument seeds.
        </p>
        <h2>How to use:</h2>
        <ul>
          <li>Use the QWERTY keys on your keyboard to play notes (Q is middle C)</li>
          <li>Change the octave using the dropdown or Page Up/Down keys</li>
          <li>Modify the instrument seed manually or click "Random Instrument"</li>
          <li>Use + and - keys to cycle through instrument seeds</li>
        </ul>
        <div class="notice" role="alert">
          <strong>Notice:</strong> As this synth generates random sounds, some may be unexpected or harsh. Please listen at a safe and comfortable volume to
          protect your hearing and enjoy the experience.
        </div>
        <h2>Instrument Selector</h2>
        <div class="editor">
          <div class="preset-list" role="group" aria-label="Instrument presets">
            <strong id="preset-label">Presets:</strong>
            <a href="?instrumentSeed=2550542884" aria-labelledby="preset-label">Cavern Drips</a>
            <a href="?instrumentSeed=780366392" aria-labelledby="preset-label">Nice Pluck</a>
            <a href="?instrumentSeed=1886683946" aria-labelledby="preset-label">Piff</a>
            <a href="?instrumentSeed=1190652164" aria-labelledby="preset-label">Bubble</a>
            <a href="?instrumentSeed=1926572373" aria-labelledby="preset-label">Quock</a>
            <a href="?instrumentSeed=1274513689" aria-labelledby="preset-label">BandSaw</a>
            <a href="?instrumentSeed=2188131601" aria-labelledby="preset-label">Little Saw</a>
            <a href="?instrumentSeed=4044828069" aria-labelledby="preset-label">Phat Boy</a>
            <a href="?instrumentSeed=2220436593" aria-labelledby="preset-label">Boop</a>
            <a href="?instrumentSeed=3252127078" aria-labelledby="preset-label">Zong</a>
            <a href="?instrumentSeed=1762204959" aria-labelledby="preset-label">Flyby</a>
            <a href="?instrumentSeed=954764011" aria-labelledby="preset-label">Wow!</a>
            <a href="?instrumentSeed=145437930" aria-labelledby="preset-label">Snare</a>
            <a href="?instrumentSeed=2887395281" aria-labelledby="preset-label">Stab bass</a>
            <a href="?instrumentSeed=1511333983" aria-labelledby="preset-label">Woof</a>
            <a href="?instrumentSeed=2882963148" aria-labelledby="preset-label">Slap</a>
            <a href="?instrumentSeed=789752148" aria-labelledby="preset-label">Snare2</a>
            <a href="?instrumentSeed=4108768165" aria-labelledby="preset-label">Bass touch</a>
            <a href="?instrumentSeed=2180840688" aria-labelledby="preset-label">Echo bell</a>
            <a href="?instrumentSeed=1579750160" aria-labelledby="preset-label">Sticky bass</a>
            <a href="?instrumentSeed=2954907572" aria-labelledby="preset-label">Abduction</a>
            <a href="?instrumentSeed=3827537414" aria-labelledby="preset-label">Snap</a>
            <a href="?instrumentSeed=666" aria-labelledby="preset-label">Devilish</a>
            <a href="?instrumentSeed=69420" aria-labelledby="preset-label">MeMe</a>
          </div>
          <div>
            <label for="octaveSelect">Octave</label>
            <select id="octaveSelect">
              <option value="-3">-3</option>
              <option value="-2">-2</option>
              <option value="-1">-1</option>
              <option value="0" selected>0</option>
              <option value="1">+1</option>
              <option value="2">+2</option>
              <option value="3">+3</option>
            </select>
          </div>
          <div>
            <label for="instrumentSeedInput">Instrument Seed</label>
            <input id="instrumentSeedInput" type="number" value="0" aria-describedby="seedHelp" />
            <span id="seedHelp" class="sr-only">Enter a number to generate a specific instrument</span>
            <button id="randomInstrumentButton">Random Instrument</button>
          </div>
          <div class="piano" id="pianoKeyboard"></div>
          <h2>Instrument Structure</h2>
          <p>
            Expand the section below if you want to see how an instrument is represented internally. If you wanted to, you could create your own instruments for
            the synth instead of using the random generator by following this format. This format is explained on <a href="https://github.com/AlexanderParker/zyn">GitHub</a>.
          </p>
          <button type="button" class="collapsible" aria-expanded="false" aria-controls="instrumentStructure">Instrument Structure</button>
          <div id="instrumentStructure" class="content" aria-hidden="true">
            <pre id="instrumentJson"></pre>
          </div>
        </div>
      </main>
      <footer>
        <a href="https://github.com/AlexanderParker/zyn" class="github-link">
          <img src="https://github.com/favicon.ico" alt="" />
          View on GitHub
        </a>
      </footer>
    </div>

    <script>
      const ZynDemo = {
        randInstrumentSeed: 0,
        randInstrument: {},
        pressedKeys: {},

        init() {
          if (!Z.ctx) Z.init();
          this.attachEventListeners();
          this.loadStateAndUpdateInstrument();
          this.setupCollapsible();
          this.createPianoKeyboard();
        },

        getInstrument(seed) {
          this.randInstrument = Z.getInstrument(seed);
          return this.randInstrument;
        },

        updateInstrument(seed) {
          if (!Z.ctx) Z.init();          
          this.randInstrumentSeed = seed;
          this.getInstrument(seed);
          this.writeInstrumentToDiv();
        },

        handleKeyPress(event) {
          if (this.pressedKeys[event.key.toLowerCase()]) return;
          if (this.isTextInputActive()) return;

          const key = event.key.toLowerCase();
          const octaveSelect = document.getElementById("octaveSelect");
          const instrumentSeedInput = document.getElementById("instrumentSeedInput");

          if (key === "+" || key === "-") {
            const currentSeed = parseInt(instrumentSeedInput.value);
            instrumentSeedInput.value = key === "+" ? currentSeed + 1 : currentSeed - 1;
            this.updateInstrumentAndPushState(parseInt(instrumentSeedInput.value));
          } else if (key === "pageup" || key === "pagedown") {
            const currentOctave = parseInt(octaveSelect.value);
            octaveSelect.value = key === "pageup" ? Math.min(currentOctave + 1, 3) : Math.max(currentOctave - 1, -3);
            event.preventDefault();
          } else {
            this.playNote(key);
          }
        },

        createPianoKeyboard() {
          const keyboard = document.getElementById("pianoKeyboard");
          const keys = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

          for (let i = 0; i < 17; i++) {
            const key = document.createElement("div");
            const note = i % 12;
            key.className = `key ${["C#", "D#", "F#", "G#", "A#"].includes(keys[note]) ? "black" : "white"}`;
            key.dataset.note = i;
            key.addEventListener("mousedown", () => this.playPianoNote(i));
            key.addEventListener("mouseup", () => this.stopPianoNote(i));
            key.addEventListener("touchstart", (e) => {
              e.preventDefault();
              this.playPianoNote(i);
            });
            key.addEventListener("touchend", (e) => {
              e.preventDefault();
              this.stopPianoNote(i);
            });
            keyboard.appendChild(key);
          }
        },

        playPianoNote(note) {
          const octave = parseInt(document.getElementById("octaveSelect").value);
          Z.play(note + octave * 12, this.randInstrument, 1);
          document.querySelector(`[data-note="${note}"]`).classList.add("pressed");
        },

        stopPianoNote(note) {
          document.querySelector(`[data-note="${note}"]`).classList.remove("pressed");
        },

        playNote(key) {
          const keyToNoteMap = {
            q: 0,
            2: 1,
            w: 2,
            3: 3,
            e: 4,
            r: 5,
            5: 6,
            t: 7,
            6: 8,
            y: 9,
            7: 10,
            u: 11,
            i: 12,
            9: 13,
            o: 14,
            0: 15,
            p: 16,
          };
          const note = keyToNoteMap[key];
          if (note !== undefined) {
            this.playPianoNote(note);
          }
        },

        handleKeyUp(event) {
          const keyToNoteMap = {
            q: 0,
            2: 1,
            w: 2,
            3: 3,
            e: 4,
            r: 5,
            5: 6,
            t: 7,
            6: 8,
            y: 9,
            7: 10,
            u: 11,
            i: 12,
            9: 13,
            o: 14,
            0: 15,
            p: 16,
          };
          const note = keyToNoteMap[event.key.toLowerCase()];
          if (note !== undefined) {
            this.stopPianoNote(note);
          }
          delete this.pressedKeys[event.key.toLowerCase()];
        },

        writeInstrumentToDiv() {
          const container = document.getElementById("instrumentJson");
          container.textContent = JSON.stringify(this.randInstrument, null, 2);
        },

        handleRandomInstrument() {
          const newSeed = Math.floor(Math.random() * Z.mInt);
          document.getElementById("instrumentSeedInput").value = newSeed;
          this.updateInstrumentAndPushState(newSeed);
        },

        updateInstrumentAndPushState(seed) {
          this.updateInstrument(seed);
          this.pushStateToHistory(seed);
        },

        pushStateToHistory(instrumentSeed) {
          const state = { instrumentSeed };
          const url = `?instrumentSeed=${instrumentSeed}`;
          history.pushState(state, "", url);
        },

        loadStateAndUpdateInstrument() {
          const urlParams = new URLSearchParams(window.location.search);
          const instrumentSeed = urlParams.get("instrumentSeed") || 0;
          document.getElementById("instrumentSeedInput").value = instrumentSeed;
          this.updateInstrument(parseInt(instrumentSeed));
        },

        handlePopState(event) {
          if (event.state && event.state.instrumentSeed !== undefined) {
            const instrumentSeed = event.state.instrumentSeed;
            document.getElementById("instrumentSeedInput").value = instrumentSeed;
            this.updateInstrument(parseInt(instrumentSeed));
          } else {
            this.loadStateAndUpdateInstrument();
          }
        },

        isTextInputActive() {
          const tag = document.activeElement.tagName;
          return tag === "INPUT" || tag === "TEXTAREA";
        },

        setupCollapsible() {
          const coll = document.getElementsByClassName("collapsible");
          for (let i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function () {
              this.classList.toggle("active");
              const content = this.nextElementSibling;
              const isExpanded = this.classList.contains("active");
              this.setAttribute("aria-expanded", isExpanded);
              content.style.display = isExpanded ? "block" : "none";
              content.setAttribute("aria-hidden", !isExpanded);
            });
          }
        },

        attachEventListeners() {
          document.addEventListener("keydown", this.handleKeyPress.bind(this));
          document.addEventListener("keyup", this.handleKeyUp.bind(this));
          window.addEventListener("popstate", this.handlePopState.bind(this));
          document.getElementById("instrumentSeedInput").addEventListener("change", (e) => {
            this.updateInstrumentAndPushState(parseInt(e.target.value));
          });
          document.getElementById("randomInstrumentButton").addEventListener("click", this.handleRandomInstrument.bind(this));
        },
      };

      window.addEventListener("load", () => ZynDemo.init());
    </script>
  </body>
</html>
